# MySQL连接
#### 数据库连接是一种关键的、有限的、昂贵的资源，这一点在多用户的网页应用程序中体现得尤为突出
#### 对数据库连接的管理能显著影响到整个应用程序的伸缩性和健壮性，影响到程序的性能指标
连接类型|description|方式
---|---|---
短链接|程序和数据库通信时需要建立连接，执行操作后，连接关闭|连接→数据传输→关闭连接
长连接|程序之间的连接在建立之后，就一直打开|被后续程序重用(减少连接的开销)
> ✦维持连接也是需要内存

##### 如果客户端和MySQL数据库之间有连接池或Proxy代理，一般在客户端推荐使用短连接
> 如果没有每秒几百、上千的新连接请求，就不一定需要长连接，也无法从长连接中得到太多好处

# 连接池原理
```
在系统初始化的时候，将数据库连接作为对象存储在内存中，
当用户需要访问数据库时，并非建立一个新的连接，而是从连接池中取出一个已建立的空闲连接对象。
使用完毕后，用户也并非将连接关闭，而是将连接放回连接池中，以供下一个请求访问使用。
而连接的建立、断开都由连接池自身来管理。
同时，还可以通过设置连接池的参数来控制连接池中的初始连接数、连接的上下限数以及每个连接的最大使用次数、最大空闲时间等等。
也可以通过其自身的管理机制来监视数据库连接的数量、使用情况等
```
### 注意事项
> 最小连接数与最大连接数相差太大，那么最先的连接请求将会获利，之后超过最小连接数量的连接请求等价于建立一个新的数据库连接。   
> 不过，这些新建的连接在使用完不会马上被释放，它将被放到连接池中等待重复使用或是空闲超时后被释放。   

### Django中的数据库连接
> ✈2006，MySQL server has gone away

#### 在异步脚本中 因为处理的都是websocket，不经过wsgihandler；
#### 因此数据库中超时的连接不会被及时的清理，因此导致了异步脚本中的数据库访问获取的连接可能已经超时
##### Django源码（class WSGIHandler）：
1. 加载request middleware
2. 发送request_started的信号
3. 获取response
4. 设置cookies
5. 返回response
> ✓查找这个时间注册的处理函数发现，在django.core.db.__ init __.py中注册了close_old_connections事件处理函数
```
∴每当收到一个请求，wsgihandler都会发送信号:request_start
database engine收到信号，检查所有的数据库connection是否有已经超时的，
如果未设置CONN_MAX_AGE，或者设置的时间已经超时就关闭当前的数据库连接；
因此设置适当的CONN_MAX_AGE既保证高效的重用连接，又防止长时间占用；
```
